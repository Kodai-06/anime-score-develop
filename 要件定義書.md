これまでの会話の内容（技術スタック、データベース設計、外部API連携のロジック）をすべて反映させた、ポートフォリオ制作の実装指針となる**要件定義書**を作成しました。

開発の地図として活用してください。

-----

# アニメレビューサイト 要件定義書

## 1\. プロジェクト概要

ユーザーがアニメ作品に対して0〜100点のスコアとコメントを投稿できるWebアプリケーション。
独自データベースに存在しない作品が検索された場合、外部API（Annict）から自動的にデータを取得・保存し、データベースを自己拡張していく機能を特徴とする。

## 2\. システム構成

| 区分 | 技術スタック | 備考 |
| :--- | :--- | :--- |
| **フロントエンド** | Next.js (TypeScript) | UI/UX担当 |
| **バックエンド** | Go (Gin) | APIサーバー |
| **データベース** | PostgreSQL | データ永続化 |
| **外部API** | Annict API (GraphQL) | 未登録アニメのデータソース |
| **環境構築** | Docker / Docker Compose | 開発環境のコンテナ化 |

## 3\. 機能要件

### 3.1 ユーザー機能

  * **会員登録/ログイン**: メールアドレスとパスワードによる認証。
  * **マイページ**: 自分の投稿したレビュー履歴の閲覧。

### 3.2 アニメ作品機能

  * **作品検索 (ハイブリッド検索)**:
    1.  ユーザーがタイトルで検索。
    2.  **Annict API**へ問い合わせる。
    3.  **情報取得:** Annict APIから以下の情報を取得・利用する。
    - `annictIds` (Annict作品ID)
    - `titles` (作品タイトル)
    - `seasonyear`(放送年)
    - **結果表示:** 検索結果を「タイトル」と「放送時期」のリストとして表示する。
  * **作品一覧表示**: 新着レビューや平均点順に作品を表示する
  * **作品詳細表示**: タイトル、放送年、平均点、レビュー数、レビュー一覧を表示。

### 3.3 レビュー機能

  * **レビュー投稿**:
      * 点数: 0〜100点（必須）
      * コメント: 任意のテキスト（任意）
  * **制約**: 1ユーザーにつき、1作品までしか投稿できない（多重投稿防止）。

## 4\. データベース設計

### 4.1 テーブル定義 (ER図)

#### `users` (ユーザー)

| カラム名 | 型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | SERIAL | PK | ユーザーID |
| `username` | VARCHAR | NOT NULL | 表示名 |
| `email` | VARCHAR | UNIQUE, NOT NULL | メールアドレス |
| `password_hash`| VARCHAR | NOT NULL | ハッシュ化パスワード |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 作成日時 |

#### `animes` (アニメ作品)
Annict APIから取得したアニメ情報をキャッシュ（保存）するためのテーブル。
| カラム名 | 型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | SERIAL | PK | アニメID(Annict作品id)  |
| `title` | VARCHAR | NOT NULL | 作品タイトル |
| `year` | INTEGER | NOT NULL | 放送年 (例: 2024) |
| `created_at` | TIMESTAMP | DEFAULT NOW() | データ登録日時 |

#### `reviews` (レビュー)

| カラム名 | 型 | 制約 | 説明 |
| :--- | :--- | :--- | :--- |
| `id` | SERIAL | PK | レビューID |
| `user_id` | INTEGER | FK (users) | 投稿者ID |
| `anime_id` | INTEGER | FK (animes) | 対象アニメID|
| `score` | INTEGER | 0 \<= val \<= 100 | 点数 |
| `comment` | TEXT | NULL許容 | コメント |
| `created_at` | TIMESTAMP | DEFAULT NOW() | 投稿日時 |

**制約:** `UNIQUE(user_id, anime_id)` により、1ユーザー1作品1レビューを保証。

### 4.2 ビュー定義

#### `anime_stats` (統計情報)

レビューテーブルから動的に計算される読み取り専用ビュー。

```sql
SELECT anime_id, COUNT(id) as review_count, ROUND(AVG(score), 1) as avg_score
FROM reviews GROUP BY anime_id;
```

## 5\. API エンドポイント設計 (REST)

### アニメ関連

| メソッド | URL | 説明 | 特記事項 |
| :--- | :--- | :--- | :--- |
| `GET` | `/api/animes` | アニメ一覧取得 | ページネーション対応推奨 |
| `GET` | `/api/animes/search` | アニメ検索 | **Annict連携ロジック含む** |
| `GET` | `/api/animes/:id` | アニメ詳細取得 | 統計情報も含めて返す |

### レビュー関連

| メソッド | URL | 説明 | 特記事項 |
| :--- | :--- | :--- | :--- |
| `POST` | `/api/reviews` | レビュー投稿 | 認証必須 |
| `GET` | `/api/animes/:id/reviews`| そのアニメのレビュー一覧 | 新着順などで表示 |

### 認証関連

| メソッド | URL | 説明 | 特記事項 |
| :--- | :--- | :--- | :--- |
| `POST` | `/api/signup` | ユーザー登録 | |
| `POST` | `/api/login` | ログイン | JWT等のトークン発行 |

## 6\. 開発フロー

1.  **環境構築**: Docker ComposeでPostgreSQLを立ち上げる。
2.  **DB実装**: テーブル作成、ビュー作成。
3.  **バックエンド実装 (Phase 1)**: 基本的なCRUD APIの実装。
4.  **バックエンド実装 (Phase 2)**: Annict API連携ロジックの実装。
5.  **フロントエンド実装**: Next.jsによる画面作成とAPI繋ぎ込み。

-----

この要件定義書を元に、次はいよいよコードを書き始めていきましょう。
まず\*\*「ディレクトリ構成」\*\*を切るところから始めますか？